<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Math Adventure Game for Kids! üåü</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Roboto&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        h1, h2, h3, .fredoka {
            font-family: 'Fredoka One', cursive;
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
        }
        .checkbox-label {
            transition: all 0.3s ease-in-out;
        }
        .checkbox-label:hover {
            transform: scale(1.08) rotate(2deg);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .correct-animation {
            animation: correct 0.8s ease-in-out;
        }
        @keyframes correct {
            0% { transform: scale(1); }
            25% { transform: scale(1.1) rotate(5deg); background-color: #dcfce7; }
            50% { transform: scale(1.15) rotate(-3deg); background-color: #bbf7d0; }
            75% { transform: scale(1.05) rotate(2deg); background-color: #dcfce7; }
            100% { transform: scale(1); }
        }
        .incorrect-animation {
            animation: incorrect 0.6s ease-in-out;
        }
        @keyframes incorrect {
            0%, 100% { transform: translateX(0); }
            15% { transform: translateX(-12px) rotate(-2deg); }
            30% { transform: translateX(12px) rotate(2deg); }
            45% { transform: translateX(-8px) rotate(-1deg); }
            60% { transform: translateX(8px) rotate(1deg); }
            75% { transform: translateX(-4px); }
        }

        /* Confetti Animation */
        .confetti {
            position: fixed;
            top: -10px;
            z-index: 1000;
            pointer-events: none;
        }
        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #f39c12;
            animation: confetti-fall 3s linear infinite;
        }
        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(360deg);
            }
        }
        /* Hide spin buttons on number inputs */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        input[type=number] {
          -moz-appearance: textfield;
        }

        /* Enhanced Button Styles */
        .fun-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center;
        }
        .fun-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .fun-btn:active {
            transform: translateY(0) scale(0.98);
        }

        /* Keypad Styles with Enhanced Animation */
        .keypad-btn {
            @apply text-white rounded-2xl text-3xl fredoka transition-all duration-300 transform shadow-lg border-b-4;
            background-size: 100% 200%;
            position: relative;
            overflow: hidden;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 60px;
            min-height: 60px;
        }

        @media (min-width: 640px) {
            .keypad-btn {
                width: 70px;
                height: 70px;
                min-width: 70px;
                min-height: 70px;
                font-size: 1.5rem;
            }
        }

        @media (min-width: 768px) {
            .keypad-btn {
                width: 80px;
                height: 80px;
                min-width: 80px;
                min-height: 80px;
                font-size: 1.75rem;
            }
        }

        .keypad-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 15px rgba(0,0,0,0.25);
        }
        .keypad-btn:active {
            transform: translateY(1px) scale(0.95);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }



        .btn-pink {
            @apply bg-pink-500 border-pink-700;
            background-image: linear-gradient(45deg, #ec4899, #f472b6 50%, #f9a8d4 50%);
        }
        .btn-pink:hover {
             background-position: 0 100%;
        }

        .btn-green {
            @apply bg-emerald-500 border-emerald-700;
             background-image: linear-gradient(45deg, #10b981, #34d399 50%, #6ee7b7 50%);
        }
        .btn-green:hover {
             background-position: 0 100%;
        }

        .btn-blue {
            @apply bg-blue-500 border-blue-700;
            background-image: linear-gradient(45deg, #3b82f6, #60a5fa 50%, #93c5fd 50%);
        }
         .btn-blue:hover {
             background-position: 0 100%;
        }

        .btn-orange {
            @apply bg-orange-500 border-orange-700;
            background-image: linear-gradient(45deg, #f97316, #fb923c 50%, #fdba74 50%);
        }
        .btn-orange:hover {
             background-position: 0 100%;
        }

        .btn-purple {
            @apply bg-purple-500 border-purple-700;
            background-image: linear-gradient(45deg, #a855f7, #c084fc 50%, #d8b4fe 50%);
        }
        .btn-purple:hover {
             background-position: 0 100%;
        }

        .btn-yellow {
            @apply bg-yellow-400 border-yellow-600 text-gray-800;
            background-image: linear-gradient(45deg, #facc15, #fde047 50%, #fef08a 50%);
        }
        .btn-yellow:hover {
             background-position: 0 100%;
        }

        /* Progress Bar */
        .progress-bar {
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57);
            background-size: 200% 100%;
            animation: rainbow 3s ease infinite;
        }
        @keyframes rainbow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* Star Rating */
        .star {
            color: #fbbf24;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
    </style>
</head>
<body class="text-gray-800 flex items-center justify-center min-h-screen p-2 sm:p-4">
    <!-- Audio elements for sound effects -->
    <audio id="correctSound" src="correct.mp3" preload="auto"></audio>
    <audio id="wrongSound" src="wrong.mp3" preload="auto"></audio>
    <audio id="endSound" src="end.mp3" preload="auto"></audio>
    <audio id="selectSound" src="select.mp3" preload="auto"></audio>
    <audio id="welcomeSound" src="welcome.mp3" preload="auto"></audio>

    <div class="w-full max-w-2xl mx-auto bg-white rounded-3xl shadow-2xl p-4 sm:p-6 md:p-10 space-y-6 border-4 border-yellow-300">

        <!-- Welcome Screen -->
        <div id="welcome-screen" class="screen active text-center">
            <h1 class="text-4xl md:text-5xl text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 fredoka mb-4">üéØ Math Genius! üåü</h1>
            <p class="text-xl mb-6 text-gray-700">üöÄ Let's challenge your math skills! üéâ</p>
            <div class="bg-gradient-to-r from-yellow-100 to-pink-100 rounded-2xl p-6 mb-6 border-2 border-yellow-300">
                <div class="text-6xl mb-4">üßÆ‚ú®üéì</div>
                <p class="text-lg font-semibold text-gray-800">Welcome to Math Genius! ü§ì</p>
                <p class="text-sm text-gray-700 mt-3">
                    Our smart system adapts to your unique learning style and pace so you'll never boring.
                </p>
                
                <div class="mt-4 p-4 bg-white bg-opacity-50 rounded-xl border-2 border-purple-200 shadow-sm">
                    <p class="text-sm font-medium text-purple-700 mb-3 flex items-center">
                        <span class="text-yellow-500 text-lg mr-2">üîç</span> How We Find Your Perfect Level:
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="bg-white p-3 rounded-lg border-l-4 border-blue-400">
                            <p class="font-semibold text-sm text-blue-700">üéÇ Age-based Start</p>
                            <p class="text-xs text-gray-600">We begin with questions tailored to your age group</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg border-l-4 border-green-400">
                            <p class="font-semibold text-sm text-green-700">‚è±Ô∏è Response Time</p>
                            <p class="text-xs text-gray-600">We notice how quickly you solve problems</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg border-l-4 border-yellow-400">
                            <p class="font-semibold text-sm text-yellow-700">‚úÖ Accuracy Tracking</p>
                            <p class="text-xs text-gray-600">We learn from your correct and incorrect answers</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg border-l-4 border-purple-400">
                            <p class="font-semibold text-sm text-purple-700">üìà Smart Adjustment</p>
                            <p class="text-xs text-gray-600">We continuously adapt to keep you challenged</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg border-l-4 border-brown-400">
                            <p class="font-semibold text-sm text-brown-700">üì° Real time progress</p>
                            <p class="text-xs text-gray-600">You can see your progress in real time</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg border-l-4 border-red-400">
                            <p class="font-semibold text-sm text-red-700">‚è±Ô∏è Finish anytime</p>
                            <p class="text-xs text-gray-600">You can finish anytime to know your level</p>
                        </div>
                    </div>
                </div>

                <p class="text-xs text-center text-gray-500 mt-4 font-medium">
                    Just enter your name and age below to start your personalized math adventure! üöÄ
                </p>
            </div>
            <div class="space-y-4">
                <div class="relative">
                    <span class="absolute left-3 top-3 text-2xl">üë§</span>
                    <input type="text" id="name" placeholder="What's your awesome name?" class="w-full pl-12 p-3 border-2 border-purple-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-lg">
                </div>
                <div class="relative">
                    <span class="absolute left-3 top-3 text-2xl">üéÇ</span>
                    <input type="number" id="age" placeholder="How old are you?" class="w-full pl-12 p-3 border-2 border-purple-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-lg">
                </div>
            </div>
             <button id="start-setup-btn" class="fun-btn mt-6 w-full bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white fredoka text-2xl py-4 rounded-xl shadow-lg">
                üöÄ Let's Go! üåü
             </button>
        </div>

        <!-- Setup Screen -->
        <div id="setup-screen" class="screen">
            <h2 class="text-3xl fredoka text-center text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 mb-2">
                üéÆ Choose Your Math Powers! ‚ö°
            </h2>
            <p class="text-center text-gray-600 mb-6">Pick the math skills you want to practice! üéØ</p>
            <div class="grid grid-cols-2 gap-4 text-center">
                <div>
                    <input type="checkbox" id="addition" value="+" class="hidden peer">
                    <label for="addition" class="checkbox-label block p-6 bg-gradient-to-br from-red-400 to-red-600 text-white rounded-2xl cursor-pointer peer-checked:from-red-500 peer-checked:to-red-700 peer-checked:ring-4 peer-checked:ring-red-400 peer-checked:ring-offset-2 peer-checked:shadow-xl shadow-lg transition-all duration-200">
                        <div class="text-5xl mb-2">‚ûï</div>
                        <div class="fredoka text-xl">Addition</div>
                        <div class="text-sm opacity-90">Add it up! üî¢</div>
                    </label>
                </div>
                <div>
                    <input type="checkbox" id="subtraction" value="-" class="hidden peer">
                    <label for="subtraction" class="checkbox-label block p-6 bg-gradient-to-br from-yellow-400 to-orange-500 text-white rounded-2xl cursor-pointer peer-checked:from-yellow-500 peer-checked:to-orange-600 peer-checked:ring-4 peer-checked:ring-yellow-400 peer-checked:ring-offset-2 peer-checked:shadow-xl shadow-lg transition-all duration-200">
                        <div class="text-5xl mb-2">‚ûñ</div>
                        <div class="fredoka text-xl">Subtraction</div>
                        <div class="text-sm opacity-90">Take away! üéØ</div>
                    </label>
                </div>
                <div>
                    <input type="checkbox" id="multiplication" value="*" class="hidden peer">
                    <label for="multiplication" class="checkbox-label block p-6 bg-gradient-to-br from-purple-400 to-purple-600 text-white rounded-2xl cursor-pointer peer-checked:from-purple-500 peer-checked:to-purple-700 peer-checked:ring-4 peer-checked:ring-purple-400 peer-checked:ring-offset-2 peer-checked:shadow-xl shadow-lg transition-all duration-200">
                        <div class="text-5xl mb-2">‚úñÔ∏è</div>
                        <div class="fredoka text-xl">Multiplication</div>
                        <div class="text-sm opacity-90">Times tables! üöÄ</div>
                    </label>
                </div>
                <div>
                    <input type="checkbox" id="division" value="/" class="hidden peer">
                    <label for="division" class="checkbox-label block p-6 bg-gradient-to-br from-indigo-400 to-indigo-600 text-white rounded-2xl cursor-pointer peer-checked:from-indigo-500 peer-checked:to-indigo-700 peer-checked:ring-4 peer-checked:ring-indigo-400 peer-checked:ring-offset-2 peer-checked:shadow-xl shadow-lg transition-all duration-200">
                        <div class="text-5xl mb-2">‚ûó</div>
                        <div class="fredoka text-xl">Division</div>
                        <div class="text-sm opacity-90">Share equally! üé™</div>
                    </label>
                </div>
            </div>
            <button id="start-game-btn" class="fun-btn mt-8 w-full bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white fredoka text-2xl py-4 rounded-xl shadow-lg">
                üéâ Start the Adventure! üåü
            </button>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <!-- Progress and Stats Bar -->
            <div class="bg-gradient-to-r from-purple-100 to-pink-100 rounded-2xl p-3 mb-6 space-y-2">
                <!-- First Line: Level -->
                <div class="flex justify-between items-center">
                    <span id="difficulty-display" class="fredoka text-base text-purple-600">
                        üéØ <span>Level:</span> Easy
                    </span>
                    <button id="stop-game-btn" class="bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 active:scale-95 text-white fredoka text-sm px-3 py-1 rounded-lg shadow transition-all duration-300" onclick="document.getElementById('stop-game-btn').classList.add('scale-95'); setTimeout(() => document.getElementById('stop-game-btn').classList.remove('scale-95'), 100)">
                        üõë <span>Finish</span>
                    </button>
                </div>
                
                <!-- Second Line: Score and Timer -->
                <div class="flex justify-between items-center">
                    <span id="score-display" class="fredoka text-base text-green-600">
                        ‚≠ê <span>Score:</span> 0
                    </span>
                    <span id="question-timer-display" class="fredoka text-base text-orange-600">
                        ‚è±Ô∏è <span>Time:</span> 0.0s
                    </span>
                </div>
                
                <!-- Third Line: Progress Bar -->
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="progress-bar" class="progress-bar h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>

            <!-- Question Display -->
            <div id="question-container" class="text-center text-5xl md:text-7xl p-6 md:p-8 bg-gradient-to-br from-blue-50 to-purple-50 rounded-2xl border-4 border-blue-200 shadow-lg">
                <div class="mb-4">
                    <span id="num1" class="text-blue-600"></span>
                    <span id="operator" class="text-purple-600 mx-2"></span>
                    <span id="num2" class="text-blue-600"></span>
                    <span class="text-gray-600"> = </span>
                    <span class="text-green-600">?</span>
                </div>
                <div id="stars-display" class="text-3xl"></div>
            </div>

            <!-- Answer Input -->
            <div class="relative mt-6">
                <span class="absolute left-4 top-4 text-3xl">üí≠</span>
                <input type="number" id="answer" class="w-full pl-16 pr-16 text-4xl text-center p-4 border-4 border-purple-300 rounded-2xl focus:outline-none focus:ring-4 focus:ring-purple-400 focus:border-purple-500 bg-gradient-to-r from-white to-purple-50 flex items-center" placeholder="Your answer...">
                <button id="enter-btn" class="absolute right-2 top-2 w-12 h-12 bg-green-500 hover:bg-green-600 text-white rounded-xl text-2xl flex items-center justify-center transition-all duration-300 transform hover:scale-105 active:scale-95 shadow-lg">
                    ‚Üµ
                </button>
            </div>

            <!-- Fun Keypad -->
            <div id="keypad" class="mt-6 w-full max-w-md mx-auto">
                <!-- Number Grid -->
                <div class="grid grid-cols-3 gap-3 mb-3 justify-items-center">
                    <button data-key="1" class="block p-4 w-full bg-gradient-to-br from-blue-400 to-blue-600 text-white rounded-2xl cursor-pointer hover:from-blue-500 hover:to-blue-700 active:scale-95 transition-all duration-200 text-2xl font-bold shadow-lg">1</button>
                    <button data-key="2" class="block p-4 w-full bg-gradient-to-br from-green-400 to-green-600 text-white rounded-2xl cursor-pointer hover:from-green-500 hover:to-green-700 active:scale-95 transition-all duration-200 text-2xl font-bold shadow-lg">2</button>
                    <button data-key="3" class="block p-4 w-full bg-gradient-to-br from-pink-400 to-pink-600 text-white rounded-2xl cursor-pointer hover:from-pink-500 hover:to-pink-700 active:scale-95 transition-all duration-200 text-2xl font-bold shadow-lg">3</button>
                    <button data-key="4" class="block p-4 w-full bg-gradient-to-br from-yellow-400 to-orange-500 text-white rounded-2xl cursor-pointer hover:from-yellow-500 hover:to-orange-600 active:scale-95 transition-all duration-200 text-2xl font-bold shadow-lg">4</button>
                    <button data-key="5" class="block p-4 w-full bg-gradient-to-br from-purple-400 to-purple-600 text-white rounded-2xl cursor-pointer hover:from-purple-500 hover:to-purple-700 active:scale-95 transition-all duration-200 text-2xl font-bold shadow-lg">5</button>
                    <button data-key="6" class="block p-4 w-full bg-gradient-to-br from-blue-400 to-blue-600 text-white rounded-2xl cursor-pointer hover:from-blue-500 hover:to-blue-700 active:scale-95 transition-all duration-200 text-2xl font-bold shadow-lg">6</button>
                    <button data-key="7" class="block p-4 w-full bg-gradient-to-br from-green-400 to-green-600 text-white rounded-2xl cursor-pointer hover:from-green-500 hover:to-green-700 active:scale-95 transition-all duration-200 text-2xl font-bold shadow-lg">7</button>
                    <button data-key="8" class="block p-4 w-full bg-gradient-to-br from-pink-400 to-pink-600 text-white rounded-2xl cursor-pointer hover:from-pink-500 hover:to-pink-700 active:scale-95 transition-all duration-200 text-2xl font-bold shadow-lg">8</button>
                    <button data-key="9" class="block p-4 w-full bg-gradient-to-br from-yellow-400 to-orange-500 text-white rounded-2xl cursor-pointer hover:from-yellow-500 hover:to-orange-600 active:scale-95 transition-all duration-200 text-2xl font-bold shadow-lg">9</button>
                </div>
                <!-- Bottom Row -->
                <div class="grid grid-cols-3 gap-3 justify-items-center">
                    <button id="backspace-btn" class="block p-4 w-full bg-gradient-to-br from-red-400 to-red-600 text-white rounded-2xl cursor-pointer hover:from-red-500 hover:to-red-700 active:scale-95 transition-all duration-200 text-2xl font-bold shadow-lg flex items-center justify-center">
                        ‚å´
                    </button>
                    <button data-key="0" class="block p-4 w-full bg-gradient-to-br from-purple-400 to-purple-600 text-white rounded-2xl cursor-pointer hover:from-purple-500 hover:to-purple-700 active:scale-95 transition-all duration-200 text-2xl font-bold shadow-lg">0</button>
                    <button id="numpad-enter" class="block p-4 w-full bg-gradient-to-br from-green-400 to-green-600 text-white rounded-2xl cursor-pointer hover:from-green-500 hover:to-green-700 active:scale-95 transition-all duration-200 text-2xl font-bold shadow-lg flex items-center justify-center">
                        ‚Üµ
                    </button>
                </div>
            </div>

            <button id="submit-answer-btn" class="fun-btn mt-6 w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white fredoka text-2xl py-4 rounded-2xl shadow-lg">
                üöÄ Submit Answer! ‚ú®
            </button>
            <div id="feedback" class="text-center text-3xl mt-6 font-bold h-12 fredoka"></div>

        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="screen text-center">
            <h2 class="text-4xl fredoka text-transparent bg-clip-text bg-gradient-to-r from-yellow-500 to-orange-500 mb-2">
                üéâ Amazing Job! üåü
            </h2>
            <p class="text-xl mb-6 text-gray-700" id="results-name-display"></p>

            <!-- Achievement Display -->
            <div class="bg-gradient-to-br from-yellow-100 to-orange-100 p-6 rounded-2xl space-y-6 border-4 border-yellow-300 shadow-lg">
                <div class="text-6xl mb-4">üèÜ</div>

                <div class="bg-white rounded-xl p-4 shadow-md">
                    <div class="flex justify-between items-center text-xl">
                        <span class="font-bold text-gray-700">üéØ Total Score:</span>
                        <span id="final-score" class="fredoka text-3xl text-green-600"></span>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-4 shadow-md">
                    <div class="flex flex-col items-center text-xl">
                        <span class="font-bold mb-2 text-gray-700">üß† Your Math Power Level:</span>
                        <div id="iq-level-display" class="fredoka text-6xl text-purple-600"></div>
                        <div id="achievement-badge" class="text-4xl mt-2"></div>
                        <div id="achievement-text" class="text-lg text-gray-600 mt-2 fredoka"></div>
                    </div>
                </div>

                <div id="stats-display" class="bg-white rounded-xl p-4 shadow-md">
                    <h3 class="fredoka text-xl text-gray-700 mb-3">üìä Your Stats:</h3>
                    <div class="grid grid-cols-3 gap-4 text-sm">
                        <div class="text-center">
                            <div class="text-2xl">üèÜ</div>
                            <div class="font-bold" id="difficulty-level">-</div>
                            <div class="text-gray-600">Level</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl">‚úÖ</div>
                            <div class="font-bold" id="correct-count">0</div>
                            <div class="text-gray-600">Correct</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl">‚ö°</div>
                            <div class="font-bold" id="avg-time">0s</div>
                            <div class="text-gray-600">Avg Time</div>
                        </div>
                    </div>
                </div>
            </div>

            <p class="text-xs text-gray-500 mt-4 italic">
                üí° This is a fun game score to celebrate your math skills! Keep practicing to get even better! üöÄ
            </p>
            <div class="grid grid-cols-2 gap-4 mt-6">
                <button id="whatsapp-share-btn" class="fun-btn bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white fredoka text-xl py-4 rounded-2xl shadow-lg flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="mr-2">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.966-.273-.099-.471-.148-.67.15-.197.297-.767.963-.94 1.16-.173.199-.347.222-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.795-1.484-1.781-1.66-2.08-.173-.298-.018-.46.13-.607.136-.129.296-.336.445-.504.149-.167.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.488-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.361.195 1.871.118.571-.085 1.758-.719 2.005-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-6.29 7.618h-.009c-1.77 0-3.524-.48-5.055-1.38l-.361-.216-3.75.975 1.005-3.645-.239-.375a9.878 9.878 0 0 1-1.51-5.26c.003-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 0 1 2.896 6.994c-.006 5.462-4.44 9.89-9.902 9.89M20.52 3.449C18.24 1.245 15.24 0 12.045 0 5.462 0 .106 5.334.1 11.9c0 2.096.55 4.14 1.595 5.945L0 24l6.335-1.652c1.746.943 3.71 1.444 5.71 1.447h.006c6.585 0 11.946-5.365 11.949-11.947 0-3.176-1.24-6.166-3.495-8.411"/>
                    </svg>
                    Share
                </button>
                <button id="play-again-btn" class="fun-btn bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white fredoka text-xl py-4 rounded-2xl shadow-lg">
                    üéÆ Play Again
                </button>
            </div>
        </div>

    </div>

    <script>
        // DOM Elements
        const screens = {
            welcome: document.getElementById('welcome-screen'),
            setup: document.getElementById('setup-screen'),
            game: document.getElementById('game-screen'),
            results: document.getElementById('results-screen'),
        };
        const nameInput = document.getElementById('name');
        const ageInput = document.getElementById('age');
        const startSetupBtn = document.getElementById('start-setup-btn');
        const startGametBtn = document.getElementById('start-game-btn');
        const stopGameBtn = document.getElementById('stop-game-btn');
        const submitAnswerBtn = document.getElementById('submit-answer-btn');
        const playAgainBtn = document.getElementById('play-again-btn');
        const answerInput = document.getElementById('answer');
        const keypad = document.getElementById('keypad');
        const enterBtn = document.getElementById('enter-btn');
        
        // Game State
        let gameState = {};

        function resetGameState() {
            gameState = {
                name: '',
                age: 0,
                difficulty: 1,
                operators: [],
                score: 0,
                totalQuestionsAnswered: 0,
                totalCorrectAnswers: 0,
                totalAnswerTime: 0, // in seconds
                questionStartTime: 0,
                questionTimer: 0,
                questionTimerInterval: null,
            };
        }
        
        // --- Navigation ---
        function showScreen(screenName) {
            // Hide all screens
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            // Show the requested screen
            screens[screenName].classList.add('active');
            
            // Play appropriate sound based on screen
            if (screenName === 'setup') {
                document.getElementById('selectSound').play().catch(e => console.log('Could not play select sound:', e));
            }
        }

        startSetupBtn.addEventListener('click', () => {
            const name = nameInput.value.trim();
            const age = parseInt(ageInput.value);

            if (!name || !age) {
                alert('üåü Please enter your awesome name and age so we can start the adventure! üöÄ');
                return;
            }

            resetGameState();
            gameState.name = name;
            gameState.age = age;

            // Set initial difficulty based on age - start easier for younger kids
            // Start with basic difficulty for all ages, but allow progression to highest levels
            if (age < 4) {
                gameState.difficulty = 1; // Start with very basic for youngest players
            } else if (age <= 6) {
                gameState.difficulty = 2; // Slightly higher start for ages 4-6
            } else if (age <= 9) {
                gameState.difficulty = 3; // Intermediate start for ages 7-9
            } else {
                gameState.difficulty = 4; // Higher start for ages 10+
            }

            showScreen('setup');
        });

        startGametBtn.addEventListener('click', () => {
            const checkedBoxes = document.querySelectorAll('input[type="checkbox"]:checked');
            gameState.operators = Array.from(checkedBoxes).map(box => box.value);

            if (gameState.operators.length === 0) {
                alert('üéØ Please choose at least one math power to practice! Pick your favorites! ‚ö°');
                return;
            }
            startContinuousGame();
        });

        // Confetti function for celebrations
        function createConfetti() {
            const confettiContainer = document.createElement('div');
            confettiContainer.className = 'confetti';
            confettiContainer.style.left = Math.random() * 100 + '%';
            document.body.appendChild(confettiContainer);

            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff'];

            for (let i = 0; i < 10; i++) {
                const piece = document.createElement('div');
                piece.className = 'confetti-piece';
                piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                piece.style.left = Math.random() * 100 + 'px';
                piece.style.animationDelay = Math.random() * 3 + 's';
                piece.style.animationDuration = (Math.random() * 2 + 2) + 's';
                confettiContainer.appendChild(piece);
            }

            setTimeout(() => {
                document.body.removeChild(confettiContainer);
            }, 5000);
        }
        
        // --- Input Handling ---
        answerInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                submitAnswerBtn.click();
            }
        });

        keypad.addEventListener('click', (event) => {
            const key = event.target.dataset.key;
            if (!key) return; // Exit if they clicked the gap between buttons

            if (key >= '0' && key <= '9') {
                answerInput.value += key;
            }
            answerInput.focus();
        });

        // Backspace button functionality
        document.getElementById('backspace-btn').addEventListener('click', () => {
            answerInput.value = answerInput.value.slice(0, -1);
            answerInput.focus();
        });

        // Numpad enter button functionality
        document.getElementById('numpad-enter').addEventListener('click', () => {
            submitAnswerBtn.click();
        });

        // Enter button functionality
        enterBtn.addEventListener('click', () => {
            submitAnswerBtn.click();
        });

        // --- Game Logic ---
        function startContinuousGame() {
            // Reset stats for a new session
            gameState.score = 0;
            gameState.totalQuestionsAnswered = 0;
            gameState.totalCorrectAnswers = 0;
            gameState.totalAnswerTime = 0;
            
            showScreen('game');
            generateAndDisplayQuestion();
        }
        
        function getDifficultyText(difficulty) {
            // Unified difficulty levels for all ages
            if (difficulty <= 3) {
                return 'üå± Beginner';
            } else if (difficulty <= 6) {
                return '‚≠ê Novice';
            } else if (difficulty <= 9) {
                return 'üöÄ Advanced';
            } else if (difficulty <= 12) {
                return 'üî• Expert';
            } else if (difficulty <= 15) {
                return 'üéØ Master';
            } else {
                return 'üß† Grand Master';
            }
        }

        function updateDifficultyDisplay() {
            const difficultyText = getDifficultyText(gameState.difficulty);
            document.getElementById('difficulty-display').innerHTML = `üéØ Level: ${difficultyText}`;

            // Update score display
            document.getElementById('score-display').innerHTML = `‚≠ê Score: ${gameState.score}`;

            // Update progress bar based on questions answered
            const progress = Math.min((gameState.totalQuestionsAnswered * 10), 100);
            document.getElementById('progress-bar').style.width = progress + '%';
        }

        function generateAndDisplayQuestion() {
            const operator = gameState.operators[Math.floor(Math.random() * gameState.operators.length)];
            let num1, num2, answer;

            // Unified difficulty scaling for all ages
            let baseMaxNum, baseMinNum, multiplicationMax;
            
            // Scale number ranges based on difficulty level (1-20+)
            if (gameState.difficulty <= 3) {
                // Beginner: 1-digit numbers
                baseMinNum = 1;
                baseMaxNum = 5 + gameState.difficulty;
                multiplicationMax = 5;
            } else if (gameState.difficulty <= 7) {
                // Novice: 1-2 digit numbers
                baseMinNum = 1;
                baseMaxNum = 10 + (gameState.difficulty * 2);
                multiplicationMax = 10;
            } else if (gameState.difficulty <= 12) {
                // Advanced: 2-3 digit numbers
                baseMinNum = 10;
                baseMaxNum = 50 + ((gameState.difficulty - 7) * 20);
                multiplicationMax = 15;
            } else if (gameState.difficulty <= 15) {
                // Expert: 3-4 digit numbers
                baseMinNum = 50;
                baseMaxNum = 200 + ((gameState.difficulty - 12) * 100);
                multiplicationMax = 20;
            } else {
                // Master: 4 digit numbers and beyond
                baseMinNum = 100;
                baseMaxNum = 1000 + ((gameState.difficulty - 15) * 200);
                multiplicationMax = 25;
            }

            if (operator === '+') {
                num1 = Math.floor(Math.random() * baseMaxNum) + baseMinNum;
                num2 = Math.floor(Math.random() * baseMaxNum) + baseMinNum;
                answer = num1 + num2;

                // For very young kids, keep sums under 10 initially
                if (gameState.age <= 6 && gameState.difficulty <= 3 && answer > 10) {
                    num2 = Math.max(1, 10 - num1);
                    answer = num1 + num2;
                }
            } else if (operator === '-') {
                // Ensure positive results for younger children
                const a = Math.floor(Math.random() * baseMaxNum) + baseMinNum;
                const b = Math.floor(Math.random() * baseMaxNum) + baseMinNum;
                num1 = Math.max(a, b);
                num2 = Math.min(a, b);
                answer = num1 - num2;

                // For very young kids, keep first number small initially
                if (gameState.age <= 6 && gameState.difficulty <= 3) {
                    num1 = Math.min(num1, 9);
                    num2 = Math.min(num2, num1);
                    answer = num1 - num2;
                }
            } else if (operator === '*') {
                const maxFactor = Math.min(multiplicationMax, Math.ceil(Math.sqrt(baseMaxNum)));
                
                if (gameState.difficulty <= 5) {
                    // Simple multiplication tables at lower levels
                    num1 = Math.floor(Math.random() * (maxFactor - 1)) + 2;
                    num2 = Math.floor(Math.random() * (maxFactor - 1)) + 2;
                } else if (gameState.difficulty <= 10) {
                    // Larger numbers, but one factor is still small
                    num1 = Math.floor(Math.random() * (maxFactor * 2 - 1)) + 2;
                    num2 = Math.floor(Math.random() * (maxFactor - 1)) + 2;
                } else {
                    // Full range multiplication at higher levels
                    num1 = Math.floor(Math.random() * (maxFactor - 1)) + 2;
                    num2 = Math.floor(Math.random() * (maxFactor - 1)) + 2;
                }
                answer = num1 * num2;
            } else if (operator === '/') {
                // Division: ensure whole number results
                const divisor = Math.floor(Math.random() * multiplicationMax) + 1;
                answer = Math.floor(Math.random() * multiplicationMax) + 1;
                num1 = divisor * answer;
                num2 = divisor;

                // For young kids, start with very simple division
                if (gameState.age <= 6 && gameState.difficulty <= 5) {
                    num1 = Math.min(num1, 9);
                    num2 = Math.min(num2, 3);
                    answer = num1 / num2;
                }
            }

            gameState.currentQuestion = { num1, num2, operator, answer };

            document.getElementById('num1').innerText = num1;
            document.getElementById('operator').innerText = operator === '*' ? '√ó' : operator === '/' ? '√∑' : operator;
            document.getElementById('num2').innerText = num2;
            answerInput.value = '';
            answerInput.focus();

            updateDifficultyDisplay();

            // Start the visual timer for this question
            gameState.questionStartTime = Date.now();
            gameState.questionTimer = 0;
            const timerDisplay = document.getElementById('question-timer-display');
            timerDisplay.innerText = `‚è±Ô∏è Time: 0.0s`;

            clearInterval(gameState.questionTimerInterval); // Clear previous timer
            gameState.questionTimerInterval = setInterval(() => {
                gameState.questionTimer += 0.1;
                timerDisplay.innerText = `‚è±Ô∏è Time: ${gameState.questionTimer.toFixed(1)}s`;
            }, 100);
        }

        submitAnswerBtn.addEventListener('click', () => {
            if (answerInput.value === '') return;

            clearInterval(gameState.questionTimerInterval); // Stop the question timer

            const answerTime = (Date.now() - gameState.questionStartTime) / 1000; // in seconds
            gameState.totalAnswerTime += answerTime;
            gameState.totalQuestionsAnswered++;

            const userAnswer = parseInt(answerInput.value);
            const correctAnswer = gameState.currentQuestion.answer;
            const feedbackEl = document.getElementById('feedback');
            const questionContainer = document.getElementById('question-container');
            const starsDisplay = document.getElementById('stars-display');

            feedbackEl.classList.remove('correct-animation', 'incorrect-animation', 'text-green-500', 'text-red-500');
            questionContainer.classList.remove('correct-animation', 'incorrect-animation');

            if (userAnswer === correctAnswer) {
                gameState.totalCorrectAnswers++;
                gameState.score += gameState.difficulty * 10;
                
                // Play correct answer sound
                document.getElementById('correctSound').play().catch(e => console.log('Could not play sound:', e));

                // Fun encouraging messages
                const correctMessages = [
                    "üåü Fantastic! You're amazing!",
                    "üéâ Brilliant work, math star!",
                    "‚ö° Super smart! Keep going!",
                    "üöÄ Outstanding! You rock!",
                    "‚ú® Perfect! You're on fire!",
                    "üéØ Excellent! Math genius!",
                    "üèÜ Incredible! Well done!",
                    "üí´ Awesome! You got it!"
                ];

                feedbackEl.innerText = correctMessages[Math.floor(Math.random() * correctMessages.length)];
                feedbackEl.className = 'text-green-300 text-sm sm:text-base md:text-lg transition-all duration-200';
                questionContainer.classList.add('correct-animation');

                // Add stars based on speed
                let stars = "‚≠ê";
                if (answerTime < 3) stars = "‚≠ê‚≠ê‚≠ê";
                else if (answerTime < 5) stars = "‚≠ê‚≠ê";
                starsDisplay.innerText = stars;

                // Create confetti for great answers
                if (answerTime < 4 || gameState.totalCorrectAnswers % 5 === 0) {
                    createConfetti();
                }

                // Adaptive difficulty: increase if correct and fast
                if (answerTime < 3) {
                    gameState.difficulty++;
                } else if (answerTime < 5) {
                    // Stays the same
                } else {
                    // Decrease difficulty if correct but slow
                    if (gameState.difficulty > 1) gameState.difficulty--;
                }

            } else {
                const encouragingMessages = [
                    `ü§î Close! The answer was ${correctAnswer}. You'll get the next one!`,
                    `üí™ Good try! It was ${correctAnswer}. Keep going, you're learning!`,
                    `üåü Almost! The answer was ${correctAnswer}. You're getting better!`,
                    `üöÄ Nice effort! It was ${correctAnswer}. Practice makes perfect!`,
                    `‚ú® Good thinking! The answer was ${correctAnswer}. Try again!`
                ];

                // Play wrong answer sound
                document.getElementById('wrongSound').play().catch(e => console.log('Could not play sound:', e));
                
                feedbackEl.innerText = encouragingMessages[Math.floor(Math.random() * encouragingMessages.length)];
                feedbackEl.className = 'text-orange-500 text-sm sm:text-base md:text-lg transition-all duration-200';
                questionContainer.classList.add('incorrect-animation');
                starsDisplay.innerText = "üí™";

                // Adaptive difficulty: decrease if incorrect
                if (gameState.difficulty > 1) gameState.difficulty--;
            }

            // Move to next question after a short delay
            setTimeout(() => {
                feedbackEl.innerText = "";
                starsDisplay.innerText = "";
                questionContainer.classList.remove('correct-animation', 'incorrect-animation');
                generateAndDisplayQuestion();
            }, 1500);
        });
        
        function calculateAndShowFinalResults() {
            clearInterval(gameState.questionTimerInterval);
            if (gameState.totalQuestionsAnswered === 0) {
                showScreen('setup');
                return;
            }

            // --- Revised Math Power Level Calculation ---
            const accuracy = (gameState.totalCorrectAnswers / gameState.totalQuestionsAnswered) * 100;
            const averageTime = gameState.totalAnswerTime / gameState.totalQuestionsAnswered;

            // 1. Base score from difficulty
            let mathPower = gameState.difficulty * 8;

            // 2. Bonus for accuracy
            mathPower += accuracy * 0.5;

            // 3. Bonus for speed (more points for faster answers)
            if (averageTime < 5) {
                mathPower += (5 - averageTime) * 3;
            }

            // 4. Add score as a bonus
            mathPower += gameState.score / 50;

            // Normalize to a fun range (e.g., 70-200)
            mathPower = Math.round(Math.max(70, Math.min(200, mathPower)));

            // Determine achievement badge and message
            let badge = "üåü";
            let achievementText = "Great job practicing!";

            if (mathPower >= 180) {
                badge = "üß†üëë";
                achievementText = "Math Genius! Incredible!";
            } else if (mathPower >= 160) {
                badge = "üöÄ‚≠ê";
                achievementText = "Math Superstar! Amazing!";
            } else if (mathPower >= 140) {
                badge = "üéØüåü";
                achievementText = "Math Champion! Excellent!";
            } else if (mathPower >= 110) {
                badge = "üí™‚ö°";
                achievementText = "Math Hero! Well done!";
            } else {
                badge = "üå±üí´";
                achievementText = "Math Explorer! Keep going!";
            }

            // Update display elements
            document.getElementById('results-name-display').innerHTML = `üéâ Fantastic work, ${gameState.name}! üåü`;
            document.getElementById('final-score').innerText = gameState.score.toLocaleString();
            document.getElementById('iq-level-display').innerText = mathPower;
            document.getElementById('achievement-badge').innerText = badge;
            document.getElementById('achievement-text').innerText = achievementText;

            // Update stats
            document.getElementById('correct-count').innerText = `${gameState.totalCorrectAnswers}/${gameState.totalQuestionsAnswered}`;
            document.getElementById('avg-time').innerText = averageTime.toFixed(1) + 's';
            document.getElementById('difficulty-level').innerText = getDifficultyText(gameState.difficulty);

            // Play end sound
            document.getElementById('endSound').play().catch(e => console.log('Could not play end sound:', e));

            // Celebration confetti for good performance
            if (mathPower >= 120 || accuracy >= 80) {
                setTimeout(createConfetti, 500);
                setTimeout(createConfetti, 1000);
            }

            showScreen('results');
        }

        // Stop game button functionality
        console.log('Adding click event listener to stopGameBtn');
        stopGameBtn.addEventListener('click', () => {
            console.log('Finish button clicked');
            try {
                clearInterval(gameState.questionTimerInterval);
                console.log('Timer cleared, calling calculateAndShowFinalResults');
                calculateAndShowFinalResults();
            } catch (error) {
                console.error('Error in stopGameBtn click handler:', error);
            }
        });

        // WhatsApp share functionality
        document.getElementById('whatsapp-share-btn').addEventListener('click', () => {
            const username = gameState.name || 'Math Whiz';
            const score = document.getElementById('final-score').textContent;
            const mathPower = document.getElementById('iq-level-display').textContent;
            const difficulty = gameState.score > 0 ? getDifficultyText(gameState.difficulty) : 'Unknown';
            const correct = document.getElementById('correct-count').textContent;
            const avgTime = document.getElementById('avg-time').textContent;
            
            const text = `üéâ ${username} just scored ${score} in Math Genius! üßÆ\n\n` +
                        `üí™ Math Power: ${mathPower}\n` +
                        `üèÜ Level: ${difficulty}\n` +
                        `‚úÖ Correct Answers: ${correct}\n` +
                        `‚è±Ô∏è Average Time: ${avgTime}\n\n` +
                        `Can you beat my score? Try it now @ https://mathkidz.vercel.app`;
            
            const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        });

        // Initial setup
        resetGameState();
        showScreen('welcome');
        
        // Play welcome sound on first interaction
        const playWelcomeSound = () => {
            document.getElementById('welcomeSound').play().catch(e => console.log('Could not play welcome sound:', e));
            // Remove the event listener after first interaction
            document.removeEventListener('click', playWelcomeSound);
            document.removeEventListener('keydown', playWelcomeSound);
        };
        
        // Play Again button functionality
        playAgainBtn.addEventListener('click', () => {
            // Don't reset game state completely to keep name and age
            gameState.score = 0;
            gameState.difficulty = 5;
            gameState.totalCorrectAnswers = 0;
            gameState.totalQuestionsAnswered = 0;
            gameState.totalAnswerTime = 0;
            showScreen('setup');
        });

        // Add event listeners for first interaction
        document.addEventListener('click', playWelcomeSound, { once: true });
        document.addEventListener('keydown', playWelcomeSound, { once: true });
    </script>
</body>
</html>
